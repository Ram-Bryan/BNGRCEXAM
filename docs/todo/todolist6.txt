â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TODOLIST - MODULE STATISTIQUES - RECONSTRUCTION COMPLÃˆTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“… Date: 17 fÃ©vrier 2026
ğŸ“¦ Statut: Ã€ dÃ©marrer - Phase 0 (Planification)
ğŸ¯ Objectif: Stats par ville avec DAO pattern et controller static

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ PHASE 1 : BASE DE DONNÃ‰ES (Estimation: 5min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1.1 VÃ©rifier les vues existantes
    â–¡ v_bngrc_stats_villes : ville_id, ville_nom, region_nom, nbsinistres,
      nombre_besoins, total_quantite_demandee, total_quantite_recue, ratio_satisfaction_global
    â–¡ v_bngrc_besoins_satisfaction : utilisÃ©e pour besoins par ville
    ğŸ“ Fichier: data/20260216-03-views.sql
    â± Temps estimÃ© : 3 min (vÃ©rification)
    âœ“ Ã‰tat initial : vues dÃ©jÃ  crÃ©Ã©es et fonctionnelles

1.2 CrÃ©er vue pour statistiques globales (optionnel)
    â–¡ v_bngrc_stats_global : COUNT villes, SUM besoins, ratio global
    â–¡ Cette vue peut consolider les stats affichÃ©es en haut de stats/villes.php
    â± Temps estimÃ© : 2 min
    âœ“ Ã‰tat initial : actuellement calculÃ© en PHP dans la vue


ğŸ“‹ PHASE 2 : DTO (Estimation: 25min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2.1 CrÃ©er DTOStats.php (app/dto/)
    â–¡ Namespace dto, use PDO
    â–¡ Properties PRIVÃ‰ES pour stats globales :
      - nombre_total_villes: int
      - nombre_total_besoins: int
      - total_quantite_demandee: float
      - total_quantite_recue: float
      - ratio_satisfaction_global: float
    â–¡ Properties pour cache (optionnel) :
      - villes: array (liste des villes)
    â–¡ Constructor vide
    â± Temps estimÃ© : 4 min
    âœ“ Ã‰tat initial : classe vide, aucune donnÃ©e

2.2 Getters et Setters DTOStats.php
    â–¡ 5 getters : getNombreTotalVilles(), getNombreTotalBesoins(), 
      getTotalQuantiteDemandee(), getTotalQuantiteRecue(), getRatioSatisfactionGlobal()
    â–¡ 5 setters avec fluent interface (return $this)
    â–¡ getVilles() / setVilles() pour cache
    â± Temps estimÃ© : 3 min

2.3 MÃ©thodes DAO statiques DTOStats.php (4 mÃ©thodes)
    â–¡ static getAllVilles(PDO $db): array
      â†’ SELECT * FROM v_bngrc_stats_villes ORDER BY region_nom, ville_nom
      â†’ Retourne array de toutes les villes avec leurs stats
    
    â–¡ static getVilleById(PDO $db, int $id): ?array
      â†’ SELECT * FROM v_bngrc_stats_villes WHERE ville_id = :id
      â†’ Retourne array d'une ville ou null
    
    â–¡ static getBesoinsVille(PDO $db, int $ville_id): array
      â†’ Appelle Besoin::findBesoinsSatisfactionByVille($db, $ville_id)
      â†’ Convertit avec DTOBesoin::fromArrayMultiple()
      â†’ Retourne array de DTOBesoin
    
    â–¡ static getStatsGlobales(PDO $db): array
      â†’ Calcule Ã  partir de getAllVilles() :
        * COUNT villes
        * SUM nombre_besoins
        * SUM total_quantite_demandee
        * SUM total_quantite_recue
        * Calcul ratio global : (total_recue / total_demandee) * 100
      â†’ Retourne array associatif
    â± Temps estimÃ© : 15 min
    ğŸ’¡ Pattern: toutes les requÃªtes SQL encapsulÃ©es dans DTO

2.4 Helpers DTOStats.php
    â–¡ static getRatioClass(float $ratio): string
      â†’ ratio >= 100 : 'progress-complete'
      â†’ ratio >= 50 : 'progress-partial'
      â†’ ratio < 50 : 'progress-low'
    
    â–¡ static formatQuantite(float $quantite): string
      â†’ number_format($quantite, 0, '', ' ')
    â± Temps estimÃ© : 3 min


ğŸ“‹ PHASE 3 : CONTROLLER (Estimation: 10min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3.1 Refactoring StatsController.php
    â–¡ Supprimer private $db et __construct()
    â–¡ Convertir toutes mÃ©thodes en STATIC
    â–¡ Supprimer TOUTES les requÃªtes SQL directes
    â–¡ Ã‰tat actuel : 2 mÃ©thodes (listVilles, showVilleDetail)
    ğŸ“ Fichier: app/controllers/StatsController.php
    â± Temps estimÃ© : 3 min

3.2 MÃ©thode listVilles() refactorisÃ©e
    â–¡ public static function listVilles(): void
    â–¡ $db = Flight::db()
    â–¡ $villes = DTOStats::getAllVilles($db)
    â–¡ $statsGlobales = DTOStats::getStatsGlobales($db)
    â–¡ Flight::render('stats/villes', [
        'villes' => $villes,
        'stats' => $statsGlobales
      ])
    ğŸ“ Ancien code: 5 lignes SQL â†’ nouveau: 2 appels DAO
    â± Temps estimÃ© : 4 min

3.3 MÃ©thode showVilleDetail() refactorisÃ©e
    â–¡ public static function showVilleDetail(int $id): void
    â–¡ $db = Flight::db()
    â–¡ $ville = DTOStats::getVilleById($db, $id)
    â–¡ if (!$ville) : Flight::redirect('/stats?error=ville_not_found')
    â–¡ $besoins = DTOStats::getBesoinsVille($db, $id)
    â–¡ Flight::render('stats/ville_detail', [
        'ville' => $ville,
        'besoins' => $besoins
      ])
    ğŸ“ Ancien code: 2 requÃªtes SQL â†’ nouveau: 2 appels DAO
    â± Temps estimÃ© : 3 min


ğŸ“‹ PHASE 4 : VIEWS (Estimation: 15min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4.1 Mise Ã  jour stats/villes.php
    â–¡ Supprimer logique PHP inline pour calculs stats globales :
      $totalBesoins = array_sum(...);
      $totalDemande = array_sum(...);
      $totalRecue = array_sum(...);
      $ratioGlobal = ...;
    â–¡ Utiliser $stats passÃ© par controller :
      $stats['nombre_total_villes']
      $stats['nombre_total_besoins']
      $stats['ratio_satisfaction_global']
    â–¡ Simplifier affichage stat-cards (utiliser donnÃ©es prÃ©-calculÃ©es)
    â–¡ Supprimer calcul inline $ratio, $class, $width dans la boucle
    â–¡ Utiliser DTOStats::getRatioClass() si besoin (ou prÃ©-calculer dans controller)
    ğŸ“ Fichier: app/views/stats/villes.php (lignes 14-19, 71-75)
    ğŸ’¡ Principe: View affiche, Controller/DTO calcule
    â± Temps estimÃ© : 8 min

4.2 VÃ©rifier stats/ville_detail.php
    â–¡ View dÃ©jÃ  corrigÃ©e pour utiliser getters de DTOBesoin
    â–¡ VÃ©rifier que calcul $ratio, $class, $width peut Ãªtre dÃ©placÃ© dans controller
    â–¡ Optionnel : prÃ©-calculer ces valeurs dans showVilleDetail()
    ğŸ“ Fichier: app/views/stats/ville_detail.php (lignes 70-75)
    â± Temps estimÃ© : 3 min

4.3 Gestion des erreurs dans views
    â–¡ Afficher message si $_GET['error'] existe dans stats/villes.php (dÃ©jÃ  fait)
    â–¡ Afficher empty-state si count($villes) == 0 (dÃ©jÃ  fait)
    â–¡ Afficher empty-state si count($besoins) == 0 dans ville_detail.php (dÃ©jÃ  fait)
    â± Temps estimÃ© : 2 min

4.4 AmÃ©liorer prÃ©sentation (optionnel)
    â–¡ IcÃ´nes pour les stat-cards (ğŸ™ï¸ ğŸ“‹ ğŸ“Š)
    â–¡ Hover effect sur les lignes du tableau (dÃ©jÃ  cliquable)
    â–¡ Animation sur barres de progression
    â± Temps estimÃ© : 2 min


ğŸ“‹ PHASE 5 : ROUTES (Estimation: 2min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5.1 Mise Ã  jour routes.php
    â–¡ Remplacer : Flight::route('GET /stats', [new StatsController(), 'listVilles'])
    â–¡ Par : Flight::route('GET /stats', [StatsController::class, 'listVilles'])
    â–¡ Remplacer : Flight::route('GET /stats/ville/@id', [new StatsController(), 'showVilleDetail'])
    â–¡ Par : Flight::route('GET /stats/ville/@id', [StatsController::class, 'showVilleDetail'])
    ğŸ“ Fichier: app/routes.php (lignes 51-52)
    â± Temps estimÃ© : 2 min


ğŸ“‹ PHASE 6 : TESTS & VALIDATION (Estimation: 8min)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6.1 Test page liste des villes
    â–¡ AccÃ©der Ã  http://localhost:1234/stats
    â–¡ VÃ©rifier affichage des 3 stat-cards (villes, besoins, satisfaction)
    â–¡ VÃ©rifier tableau avec toutes les villes
    â–¡ VÃ©rifier barres de progression colorÃ©es
    â–¡ VÃ©rifier lien "DÃ©tail" fonctionne
    â± Temps estimÃ© : 3 min

6.2 Test page dÃ©tail ville
    â–¡ AccÃ©der Ã  http://localhost:1234/stats/ville/1
    â–¡ VÃ©rifier header ville avec nom, rÃ©gion, stats
    â–¡ VÃ©rifier tableau des besoins avec colonnes complÃ¨tes
    â–¡ VÃ©rifier que besoins satisfaits/non-satisfaits s'affichent correctement
    â–¡ VÃ©rifier barres de progression par besoin
    â± Temps estimÃ© : 3 min

6.3 Test gestion erreurs
    â–¡ AccÃ©der Ã  ville inexistante : http://localhost:1234/stats/ville/999
    â–¡ VÃ©rifier redirection vers /stats?error=ville_not_found
    â–¡ VÃ©rifier message d'erreur s'affiche correctement
    â± Temps estimÃ© : 2 min


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RÃ‰SUMÃ‰ GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Temps total estimÃ© : 65 minutes (1h05)

Phase 1 (DB)         : 5 min  âœ“ Vues existantes, vÃ©rification
Phase 2 (DTO)        : 25 min â†’ DTOStats avec 4 mÃ©thodes DAO
Phase 3 (Controller) : 10 min â†’ StatsController static, 0 SQL
Phase 4 (Views)      : 15 min â†’ Suppression logique inline
Phase 5 (Routes)     : 2 min  â†’ Pattern static
Phase 6 (Tests)      : 8 min  â†’ Validation fonctionnelle

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ OBJECTIFS ARCHITECTURAUX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Pattern DAO : toutes requÃªtes SQL dans DTOStats
âœ“ Controller lÃ©ger : 0 SQL, juste orchestration
âœ“ Controller static : pas d'instance, Flight::db() par mÃ©thode
âœ“ Views simplifiÃ©es : affichage uniquement, 0 logique mÃ©tier
âœ“ Routes static : [ClassName::class, 'method']
âœ“ RÃ©utilisation : Besoin::findBesoinsSatisfactionByVille() + DTOBesoin
âœ“ Consistency : mÃªme architecture que Besoins, Dons, Achats, Simulation, RÃ©cap

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ NOTES TECHNIQUES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. DTOStats vs autres DTOs :
   - DTOBesoin, DTODon : reprÃ©sentent une entitÃ©
   - DTORecap : reprÃ©sente un agrÃ©gat de statistiques rÃ©cap
   - DTOStats : reprÃ©sente un agrÃ©gat de statistiques villes
   â†’ MÃªme pattern DAO que DTORecap

2. Calculs dans View actuellement :
   - stats/villes.php ligne 14-19 : array_sum sur $villes
   - stats/villes.php ligne 71-75 : ratio, class, width pour progress bar
   â†’ Ã€ DÃ‰PLACER dans DTOStats::getStatsGlobales() et controller

3. DÃ©pendances :
   - DTOStats utilise Besoin::findBesoinsSatisfactionByVille()
   - DTOStats utilise DTOBesoin::fromArrayMultiple()
   â†’ RÃ©utilisation du code existant (DRY principle)

4. Vues SQL nÃ©cessaires :
   - v_bngrc_stats_villes : EXISTE dÃ©jÃ  âœ“
   - v_bngrc_besoins_satisfaction : EXISTE dÃ©jÃ  âœ“
   â†’ Aucune nouvelle vue Ã  crÃ©er

5. Routes :
   - GET /stats â†’ listVilles
   - GET /stats/ville/@id â†’ showVilleDetail
   â†’ 2 routes simples, pattern cohÃ©rent

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”„ COMPARAISON AVANT/APRÃˆS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AVANT (StatsController actuel) :
â”œâ”€â”€ Instance controller avec $db
â”œâ”€â”€ 2 requÃªtes SQL directes dans controller
â”œâ”€â”€ Calculs stats globales dans view (array_sum)
â”œâ”€â”€ Calculs progress bar dans view (foreach inline)
â””â”€â”€ Routes avec [new StatsController(), 'method']

APRÃˆS (StatsController refactorisÃ©) :
â”œâ”€â”€ Static controller, Flight::db() local
â”œâ”€â”€ 0 SQL dans controller
â”œâ”€â”€ DTOStats avec 4 mÃ©thodes DAO
â”œâ”€â”€ Calculs stats dans DTO/Controller
â”œâ”€â”€ Views simplifiÃ©es (affichage pur)
â””â”€â”€ Routes avec [StatsController::class, 'method']

RÃ©duction lignes SQL dans controller : 100% (2 requÃªtes â†’ 0)
CohÃ©rence architecture : 100% (pattern uniforme sur tous modules)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
